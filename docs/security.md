# Security Guide

This guide covers security configurations for self-hosted Supabase deployments without VPS panels (EasyPanel, Coolify, etc.).

> [!TIP]
> If you're using **EasyPanel**, **Coolify**, or similar VPS panels, they handle SSL and network security automatically. You can skip this guide.

---

## Quick Security Checklist

- [ ] Enable HTTPS with Caddy (automatic SSL)
- [ ] Restrict database ports to localhost
- [ ] Configure firewall (UFW/iptables)
- [ ] Use strong auto-generated passwords (default)
- [ ] Rate limiting enabled (default in kong.yml)

---

## 1. HTTPS with Caddy (Automatic SSL)

Caddy automatically provisions and renews Let's Encrypt certificates.

### Setup

1. **Set your domain in `.env`:**
   ```bash
   DOMAIN=supabase.yourdomain.com
   ```

2. **Start with Caddy:**
   ```bash
   docker compose -f docker-compose.yml -f docker-compose.caddy.yml up -d
   ```

3. **Verify:**
   ```bash
   curl -I https://supabase.yourdomain.com
   # Should return HTTP/2 200 with valid SSL
   ```

### Requirements
- Port 80 and 443 must be open
- DNS A record pointing to your server
- Valid domain name (not IP address)

---

## 2. Restrict Database Ports

By default, database ports are exposed externally. Use the secure overlay to restrict them:

```bash
docker compose -f docker-compose.yml -f docker-compose.secure.yml up -d
```

This restricts:
| Port | Service | Access |
|------|---------|--------|
| 5432 | PostgreSQL (via Supavisor) | localhost only |
| 6543 | Supavisor Transaction Mode | localhost only |
| 4000 | Analytics (Logflare) | localhost only |

---

## 3. Full Security Stack

For maximum security, combine all overlays:

```bash
docker compose \
  -f docker-compose.yml \
  -f docker-compose.secure.yml \
  -f docker-compose.caddy.yml \
  up -d
```

---

## 4. Firewall Configuration

### UFW (Ubuntu/Debian)

```bash
# Allow SSH
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS (for Caddy)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Block direct database access (already handled by compose, but defense in depth)
sudo ufw deny 5432/tcp
sudo ufw deny 6543/tcp
sudo ufw deny 4000/tcp

# Enable firewall
sudo ufw enable
```

### iptables

```bash
# Allow established connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow SSH
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Allow HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Block database ports from external
iptables -A INPUT -p tcp --dport 5432 -j DROP
iptables -A INPUT -p tcp --dport 6543 -j DROP
iptables -A INPUT -p tcp --dport 4000 -j DROP
```

---

## 5. Rate Limiting

Rate limiting is **enabled by default** in `kong.yml`:

| Endpoint | Limit | Purpose |
|----------|-------|---------|
| `/auth/v1/*` | 20/min, 200/hour | Prevent brute-force login |
| `/rest/v1/*` | 100/min, 1000/hour | API abuse prevention |
| Dashboard (`/`) | 30/min, 300/hour | Admin panel protection |

### Customize Limits

Edit `volumes/api/kong.yml` and modify the `rate-limiting` plugin config:

```yaml
- name: rate-limiting
  config:
    minute: 50      # requests per minute
    hour: 500       # requests per hour
    policy: local   # or 'redis' for distributed
```

---

## 6. Deployment Scenarios

### Local Development
```bash
docker compose up -d
# No additional security needed
```

### VPS with Panel (EasyPanel, Coolify)
```bash
docker compose up -d
# Panel handles SSL and security
```

### VPS without Panel (Bare Metal)
```bash
docker compose \
  -f docker-compose.yml \
  -f docker-compose.secure.yml \
  -f docker-compose.caddy.yml \
  up -d
# + Configure firewall (UFW/iptables)
```

---

## 7. Security Best Practices

1. **Never expose `.env` file** - Contains all secrets
2. **Use strong passwords** - Auto-generated by default
3. **Regular backups** - Run `./scripts/backup.sh` regularly
4. **Monitor logs** - Check `docker compose logs` for suspicious activity
5. **Keep images updated** - Run `docker compose pull` periodically
6. **Rotate secrets periodically** - Use rotation scripts in `/scripts/`

---

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| SSL not working | DNS not configured | Verify A record points to server |
| 429 Too Many Requests | Rate limit exceeded | Wait or adjust limits in kong.yml |
| Can't connect to DB | Port restricted | Use Kong API or connect locally |
| Certificate error | Port 80 blocked | Open port 80 for ACME challenge |

---

## Related Documentation

- [Secrets Lifecycle](./secrets-lifecycle.md) - Key rotation procedures
- [Deployment Guide](./DEPLOYMENT.md) - Deployment options
- [Key Rotation](./KEY_ROTATION.md) - How to rotate secrets
